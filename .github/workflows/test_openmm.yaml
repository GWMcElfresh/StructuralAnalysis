name: OpenMM MD Test

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"

    - name: Set up conda
      run: |
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
        bash miniconda.sh -b -p /opt/conda && \
        rm miniconda.sh

    - name: Install OpenMM & Dependencies in Conda Env
      run: |
        sudo apt-get update
        conda create -n openmm-env python=3.9 && \
        echo "conda activate openmm-env" >> ~/.bashrc
        conda install -n openmm-env -c conda-forge openmm ambertools mdtraj numpy scipy pandas matplotlib seaborn

    - name: Initialize Conda
        run: |
          conda init bash && source ~/.bashrc

    - name: Create AA peptide and Run OpenMM Unit Test
      run: |
        cd tests
        conda activate openmm-env
        python3 generate_alanine_dipeptide.py
        pytest test_openmm_md.py
